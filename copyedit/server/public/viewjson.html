<html>
  <head>
    <title>Turk Error Finder</title>
    <script src="jquery-1.7.1.min.js"></script>
    <script>
        function $insertDB (elt, db) { db.pipe(D.swap($(elt)[0])); }
	</script>
	<script src="promptjs/p.js"></script>
	<script src="promptjs/pc.js"></script>
	<script src="promptjs/p_tests.js"></script>
	<script>
	var Z = P();
	</script>
<script>
VERBOSE = false;
THROTTLE = (1.0/9) * 1000; //min delay between XHRs
</script>
	<script src="promptjs/d.js"></script>
	<style>
	
p.file {
	margin-top: 2em;
}	
.fileName {
	font-size: 2em;
	display: block;
}
.dirName {
	color: #AAA;
	font-size: 1.0em;
}
	
p.paragraph { 
	padding: 1em; 
	border: 1px solid #CCC; 
	margin: 1em; 
}
p.paragraph .real {
	display: block;
	margin-bottom: 1em;
	padding-bottom: 1em;
	border-bottom: 1px dotted #CCC;
}
p.paragraph.off {
	opacity: 0.3;
	background-color: silver;
}

.spell > span { 
	display: inline-block;
	font-size: 1.0em;	

	background-color: blue;
	color: blue;
	width: 1em;
	height: 1em;
	overflow: hidden;
	opacity: 0.08;
}
.spell > span:hover {
	background-color: white;
	color: blue;
	width: auto;
	overflow: auto;
	opacity: 1.0;
}

.real { 
	color: black; 
	line-height: 1.5em;
}
.real span:hover { 
	border: 1px dotted red; 
}
.real span.off {
	background-color: silver;
}

.spell, .gram { color: #000 }
.spell:hover { color: #000 }

.spell, .gramSentence { margin: 1em; border-bottom-width: 2px; border-bottom-style: dotted;  }
.spell { border-bottom-color: red; }
.gram { border-bottom-color: green; }
.lblSpell, .lblGram { font-weight: bold; }
.lblSpell { color: maroon; }
.lblGram { color: green; }

.gram {
	border-bottom: 1px dotted #7F7; 
}
.gram { 
	max-width: 50em;
	height: 1em; 
	overflow: hidden; 
	color: green;
	opacity: 0.7;
	margin: 1em;
}
/*
.gram:hover { 
	height: auto; 
	opacity: 1.0;
}
*/

#summary .on, #summary .off {
	display: block;
}
	</style>
	<script>


function toggle (d) {
	var style = $(d).attr('class');	
	var toggleOn = style.indexOf('off') == -1 ? true : false;
	toggleOn = !toggleOn;
	if (toggleOn) {
		if (style.indexOf('off') != -1) style = style.replace('off','on');
		else if (style.indexOf('on') != -1) { /* nop */ }
		else style = style + " on";
	} else {
		if (style.indexOf('on') != -1) style = style.replace('on','off');
		else if (style.indexOf('off') != -1) { /* nop */ }
		else style = style + " off";	
	}	
	$(d).attr('class', style);
	return toggleOn;
}

function summarize () {

	//paragraphs
	var on = [];
	var off = [];
	$("p.paragraph").map(function (i, d) {
		if ($(this).attr('class').indexOf('off') == -1) {
			on.push(i);
		} else {
			off.push(i);
		}
	});
	
	//sentences
	var paras = $("p.paragraph").map(function (i, d) { return [[i,this]]; })
	var offSents = [];
	Array.prototype.filter.call(paras, 
		function (arr) { var d = arr[1]; return $(d).attr('class').indexOf('off') == -1; })
		.map(function (arr) {
			var paragraphId = arr[0]; var paragraphD = arr[1];
			$('.real span', paragraphD).map(function (i, d) {
				if ($(this).attr('class').indexOf('off') != -1) {
					offSents.push({para: paragraphId, sent: i});
				}
			});
		});
	
	var d = D.$span(
		$(D.$h2('Paragraphs:'))[0],
		$(D.$span('On: ' + on.join(', '))).attr('class','on')[0], 
		$(D.$span('Off: ' + off.join(', '))).attr('class','off')[0],
		$(D.$h2('Sentences:'))[0],
		$(D.$span('Off: ' + 
			offSents.map(function (o) { return '(' + o.para + ':' + o.sent + ')'; })			
					.join(', ')))
			.attr('class','off')[0]);
	$(d).attr('id','summary');	
	$insertDB('#summary', Z.unit(d));
	
	return {paras: paras, onParas: on, offSents: offSents};
}

	function formatParagraph (o, i) { // jsonParagraph -> DOM
		var sents = o.spans.map(function (span) {
			var start = span[0];
			var end = span[1];
			console.log('sent', o.paragraph.substring(start,end));
			return  o.paragraph.substring(start,end);
		});			

		var textD = 
			$(D.$span.apply({},
				sents.map(function (sent, i, arr) { 
					if (i == arr.length - 1 && (sent.trim() == '')) {
						return D.$a();
					}
					var res = D.$span(sent); 
					$(res).attr('class','on');
					$(res).click(function (event) {
						if ($(resP).attr('class').indexOf('off') == -1) {
							var toggleOn = toggle(this);
							summarize();
							event.stopPropagation();
						} else {
							//bubble to paragraph click
						}
					});
					return res;
				})))
			.attr('class','real')[0];		
		
		var resP;
		  if (o.errors.length == 0) {
		    resP = D.$p.apply({}, [textD]);
		  } else {
		  	var isSpellingError = o.errors[0].e == 'spell';
		  	var lbl = $(D.$span(isSpellingError ? "Spelling:" : "Grammar:"))
		  				.attr('class',isSpellingError ? "lblSpell" : "lblGram")[0];		  			  	
		    resP = D.$p.apply({}, [textD, lbl].concat(o.errors.map(function (err) {
		    	if (err.e == "spell") {
		    		var elt = 
		    			err.s.length > 0 ?
		    			 	D.$span(err.i[4], D.$span( D.$span.apply({}, err.s) ))
		    			 	: D.$span(err.i[4])
		    		return $(elt).attr('class','spell')[0];		    		        
		    	} else if (err.e == "gram") {
		    		var sentence = err.s.split(/\n/).shift();
		    		var messageD = D.$pre(err.s.substr(sentence.length));//output.map(function (line) { return D.$pre(line); }));
		    		sentenceD = D.$span(sentence);
		    		
		    		$(sentenceD).attr('class','gramSentence');
		    		$(messageD).attr('class','gramMessage');
		    		
		    		return $(D.$div(sentenceD, messageD)).attr('class','gram')[0];
		    	} else {
		    		throw 'unknown err: ' + err.e;
		    	}
		    })));
		  }
		
		return $(resP)
			.attr('id', 'paragraph_' + i)
			.attr('class','paragraph')
			.click(function(){
			  var toggleOn = toggle(this);
			  //var toggleOn = $(this).attr('class').indexOf('off') == -1 ? true : false;
			  //toggleOn = !toggleOn;
			  //$(this).attr('class', 'paragraph' + (toggleOn ? '' : ' off'));
			  summarize();
		})[0];
	}




	
function bindDOM() {	
	var BASE_URL = document.URL.replace("#","").replace("viewjson.html","") + "/";
	var FILE =  'out2.json';
	
	var jsonP = Z.unit(BASE_URL + FILE).pipeAsync(D.xhrJSON).print('== jsonP');
	
	DOC = jsonP.pipe(function (v) { DOC = v; });
	
	
	var docP = jsonP.pipe(function (arr) {
	
		var paragraphs = arr.map(function (o, i) { return {m: o, v: formatParagraph(o, i)}; });

		//add file breaks
		var pages = paragraphs.reduce(function (acc, o) {
			if (acc.lastFile != o.m.file) {

				var files = o.m.file.split('/');
				if (files.length > 0) {
					var lastStr = files.pop();
					var last = $(D.$span(lastStr)).attr('class', 'fileName')[0];
					var dir = $(D.$span(files.join('/') + '/')).attr('class', 'dirName')[0];
					elt = D.$span(dir, last);
				} else {
					elt = D.$span(o.m.file);
				}			
			
				var lastFileD = $(D.$p(elt)).attr('class','file')[0];
				
				$(lastFileD).click(function () {
				    var toggleOn = toggle(this);
			  		//var toggleOn = $(this).attr('class').indexOf('off') == -1 ? true : false;
					//toggleOn = !toggleOn;
					//$(this).attr('class','file' + (toggleOn ? '' : ' off'));
					var rSib = this.nextSibling;
					while (rSib) {
						if ($(rSib).attr('class').indexOf('paragraph') != -1) {
							$(rSib).attr('class', 'paragraph' + (toggleOn ? '' : ' off'));
							rSib = rSib.nextSibling;
						} else {
							rSib = false;
						}
					}
					summarize();
				});
				
				
				acc.arr.push({m: {file: o.file}, v: lastFileD});
			}
			acc.arr.push(o);
			return {arr: acc.arr, lastFile: o.m.file};		
		}, {arr: [], lastFile: false});
		
		return D.$div.apply({}, pages.arr.map(function (o) { return o.v; }));
	}).print('== docP');



    $insertDB('#doc', docP);
    
    var toggleAllOn = true;
    $('#toggleAll').click(function () {
    	toggleAllOn = !toggleAllOn;
    	$('.paragraph').attr('class','paragraph' + (toggleAllOn ? ' on' : ' off'));
    	summarize();    
    });


	function getParagraph (i) {
		var res = null;
		$("p.paragraph").map(function (idx, d) { if (idx == i) res = this; });
		return res;
	}
	function mapOffSents (offs) {
		var res = {};
		offs.forEach(function (o) {
			if (!res[o.para]) res[o.para] = [];
			res[o.para].push(o.sent);
		});	
		return res;
	}
	
	
	function fetchResults(jobID, flatSentences, batchID, paraSents) {
		$.get('api/improvements?jobID=' + jobID)
		 .done(function (data) {
		 	try {
		 	    console.log('fetched', data);
		 		var out = JSON.parse(data);
		 		if (out.count == flatSentences.length) {
		 			console.log('done, got all sentences', flatSentences, out.sentences);

					var flatDoms = Array.prototype.concat.apply([], 
    					paraSents.map(function () { return this.nodes; }));
		 			
		 			out.sentences.map(function (ratings, i) {
		 				if (ratings.length == 0) {
		 					$(flatDoms[i]).fadeTo(1000, Math.max(1.0 - ratio, 0.2));
		 				} else {
							var numOk = ratings.filter(function (o) { return o == 'ok'; }).length;
							if (numOk != ratings.length) {
								var notes = ratings.filter(function (i) { return i != 'ok'; }).join(' \n');
								console.log(
									'Rating',
									ratio, 
									flatSentences[i]);
								console.error('Corrections',notes);

								var ratio = ratings.length == 0 ? 0 : (numOk / ratings.length);
								$(flatDoms[i]).css(
									"background-color", 
									"rgb(255," 
										+ Math.round((1.0 - ratio) * 200 + 55) + "," 
										+ Math.round((1.0 - ratio) * 200 + 55) + ")");

								//tool tip
						 		var moveLeft = 20;
								var moveDown = 10;
								
								var tipText = 
									"<b>" + (ratings.length - numOk) + " Flagged</b>"
									+ "<br/><br>"
									+ notes.replace('\n','<br/><br/>');								
								$(flatDoms[i]).hover(function(e) {
								  $('#tooltip')
									.html(tipText)								  
								  	.show()
								  	.attr('class','tip' + i)
								  	.css('position', 'absolute')
									.css('top', e.pageY + moveDown)
									.css('left', e.pageX + moveLeft)
								  	.css('background-color','yellow')
								  	.css('border', '1px solid black')								
									;
								}, function() {
									setTimeout(function() { 
										if ($('#tooltip').attr('class') == 'tip' + i)
											$('#tooltip').fadeOut(1000); 
									}, 3000);
								});								
							}
						}
		 			});
		 		} else {
		 			console.log('Try again in ', out.repollDelayMS, 'ms, only got ', out.count, ' / ', flatSentences.length);
		 			setTimeout(function () {
		 					fetchResults(jobID, flatSentences, batchID, paraSents);
		 				}, out.repollDelayMS);
		 		}
		 	} catch (e) {
		 		console.log('could not handle get response', 
		 			{jobID: jobID,
		 			 flatSentences: flatSentences,
		 			 batchID: batchID},
		 			data);
		 	}
		 });
	}
	
	
    
    var batchID = 0;
    $('#query').click(function () {    
    	batchID++;
    	var summary = summarize(); //{paras: paras, onParas: on, offSents: offSents};
    	
    	var offSentMap = mapOffSents(summary.offSents);
    	
    	// {text: [ string ], nodes: [ dom] }
    	global2 = summary;
    	console.log('summary', summary);
    	var paraSents = summary.paras.map(function (id) {
    		if (summary.onParas.indexOf(id) == -1) return [];
    		
    		var paragraphD = getParagraph(id);
    		var offSents = offSentMap[id];
    		if (!offSents) offSents = [];    		
    		
    		var sents = [];
    		var sentsD = [];
    		$('.real span', paragraphD).map(function (i, d) {
    			if (offSents.indexOf(i) != -1) return null;
    			sents.push($(d).html());
    			sentsD.push(d);
			});
			return {text: sents, nodes: sentsD};
    	});
    	var flatSentences = Array.prototype.concat.apply([], 
    		paraSents.map(function () { return this.text; }));
    	
    	global = paraSents;
    	console.log(paraSents, paraSents.map(function () { return this.text; }));
    	console.log('sending', flatSentences);
    	
    	$.post('api/turkit', {sentences: flatSentences, batchID: batchID})
			.done(function (data) {
				try {
					console.log('got back', data);
					fetchResults(JSON.parse(data).jobID, flatSentences, batchID, paraSents);			
				} catch (exn) {
					console.log('failed to parse data', data, exn);
				}
			});
				

    });    
    
    $('#humani').click(function () {
		$.ajax({
			url: 'http://vivam.us/human/i',
			type: 'PUT',
			success: function(result) {
				console.log('human/i result',result);
				global = result;
			}
		});    	    
    });
    $('#humano').click(function () {
		$.ajax({
			url: 'http://vivam.us/human/o',
			type: 'PUT',
			success: function(result) {
				console.log('human/o result',result);
				global = result;
			}
		});    	    
    });
}



window.addEventListener('load',bindDOM);
	
	</script>
  </head>
  <body>
  <div id="summary"></div>
  <div>
  	<h2>Commands:</h2>
  	<input id="toggleAll" type="button" value="toggle all"/>
  	<input id="query" type="button" value="query"/>
  	<input id="humani" type="button" value="human/i"/>
  	<input id="humano" type="button" value="human/o"/>
  </div>
  <div id="doc"></div>
  <div id="tooltip"></div>
  </body>
</html>