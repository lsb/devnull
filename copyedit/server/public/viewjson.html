<html>
  <head>
    <title>Turk Error Finder</title>
    <script src="jquery-1.7.1.min.js"></script>
    <script>
        function $insertDB (elt, db) { db.pipe(D.swap($(elt)[0])); }
	</script>
	<script src="promptjs/p.js"></script>
	<script src="promptjs/pc.js"></script>
	<script src="promptjs/p_tests.js"></script>
	<script>
	var Z = P();
	</script>
<script>
VERBOSE = false;
THROTTLE = (1.0/9) * 1000; //min delay between XHRs
</script>
	<script src="promptjs/d.js"></script>
	<style>
	
p.file {
	margin-top: 2em;
}	
.fileName {
	font-size: 2em;
	display: block;
}
.dirName {
	color: #AAA;
	font-size: 1.0em;
}
	
p.paragraph { 
	padding: 1em; 
	border: 1px solid #CCC; 
	margin: 1em; 
}
p.paragraph .real {
	display: block;
}
p.paragraph.off {
	opacity: 0.3;
	background-color: silver;
}
.spell > span { 
	display: none;

	font-size: 1.0em;	

	background-color: blue;
	color: blue;
	width: 1em;
	height: 1em;
	overflow: hidden;
	opacity: 0.08;
}
.spell > span:hover {
	display: none;
	
	background-color: white;
	color: blue;
	width: auto;
	overflow: auto;
	opacity: 1.0;
}

.real { 
	color: black; 
	line-height: 1.5em;
}
.real span:hover { 
	border: 1px dotted red; 
}
.real span.off {
	background-color: silver;
}

.spell, .gram { color: #000 }
.spell:hover { color: #000 }

.spell, .gramSentence { margin: 1em; border-bottom-width: 2px; border-bottom-style: dotted;  }
.spell { border-bottom-color: red; }
.gram { border-bottom-color: blue; }
.lblSpell, .lblGram { font-weight: bold; }
.lblSpell { color: maroon; }
.lblGram { color: blue; }

.lblSpell, .lblGram, .spell, .gram { display: none; }


.gram {
	border-bottom: 1px dotted #7F7; 
}
.gram { 
	max-width: 50em;
	height: 1em; 
	overflow: hidden; 
	color: blue;
	opacity: 0.7;
	margin: 1em;
}
/*
.gram:hover { 
	height: auto; 
	opacity: 1.0;
}
*/

#summary .on, #summary .off {
	display: block;
}
	</style>


<style type="text/css" media="screen">
p.paragraph .correction {
	display: none;
}
p.paragraph .comment {
	display: none;
}
#book, #corrections {
	width: 50%;
	float: left;
	height: 100%;
	overflow: auto;
}	
#corrections {
	scrollbar: invisible;
}
</style>
<style type="text/css" media="print">
.correction {
	display: block;
}
p.paragraph .comment {
	display: block;
	padding-left: 1em;
	padding-right: 1em;
	color: red;
}
#corrections {
	display: none;
}
</style>	

	
	
	<script>


function toggle (d) {
	var style = $(d).attr('class');	
	var toggleOn = style.indexOf('off') == -1 ? true : false;
	toggleOn = !toggleOn;
	if (toggleOn) {
		if (style.indexOf('off') != -1) style = style.replace('off','on');
		else if (style.indexOf('on') != -1) { /* nop */ }
		else style = style + " on";
	} else {
		if (style.indexOf('on') != -1) style = style.replace('on','off');
		else if (style.indexOf('off') != -1) { /* nop */ }
		else style = style + " off";	
	}	
	$(d).attr('class', style);
	return toggleOn;
}

function summarize () {

	//paragraphs
	var on = [];
	var off = [];
	$("p.paragraph").map(function (i, d) {
		if ($(this).attr('class').indexOf('off') == -1) {
			on.push(i);
		} else {
			off.push(i);
		}
	});
	
	//sentences
	var paras = $("p.paragraph").map(function (i, d) { return [[i,this]]; })
	var offSents = [];
	Array.prototype.filter.call(paras, 
		function (arr) { var d = arr[1]; return $(d).attr('class').indexOf('off') == -1; })
		.map(function (arr) {
			var paragraphId = arr[0]; var paragraphD = arr[1];
			$('.real span', paragraphD).map(function (i, d) {
				if ($(this).attr('class').indexOf('off') != -1) {
					offSents.push({para: paragraphId, sent: i});
				}
			});
		});
	var onSents = $("p.paragraph.on .real .on").toArray().length;
		
	var d = D.$span(
		$(D.$h2('Paragraphs:'))[0],
		$(D.$span('On: ' + on.join(', '))).attr('class','on')[0], 
		$(D.$span('Off: ' + off.join(', '))).attr('class','off')[0],
		$(D.$h2('Sentences:'))[0],
		$(D.$span('Off: ' + 
			offSents.map(function (o) { return '(' + o.para + ':' + o.sent + ')'; })			
					.join(', ')))
			.attr('class','off')[0],
		D.$span('On (count): ' + onSents));
	$(d).attr('id','summary');	
	$insertDB('#summary', Z.unit(d));
	
	return {paras: paras, onParas: on, offSents: offSents};
}

	function formatParagraph (o, i) { // jsonParagraph -> DOM
		var sents = o.spans.map(function (span) {
			var start = span[0];
			var end = span[1];
//			console.log('sent', o.paragraph.substring(start,end));
			return  o.paragraph.substring(start,end);
		});			

		var textD = 
			$(D.$span.apply({},
				sents.map(function (sent, i, arr) { 
					if (i == arr.length - 1 && (sent.trim() == '')) {
						return D.$a();
					}
					var res = D.$span(sent); 
					$(res).attr('class','on');
					$(res).click(function (event) {
						if ($(resP).attr('class').indexOf('off') == -1) {
							var toggleOn = toggle(this);
							summarize();
							event.stopPropagation();
						} else {
							//bubble to paragraph click
						}
					});
					return res;
				})))
			.attr('class','real')[0];		
		
		var resP;
		  if (o.errors.length == 0) {
		    resP = D.$p.apply({}, [textD]);
		  } else {
		  	var isSpellingError = o.errors[0].e == 'spell';
		  	var lbl = $(D.$span(isSpellingError ? "Spelling:" : "Grammar:"))
		  				.attr('class',isSpellingError ? "lblSpell" : "lblGram")[0];		  			  	
		    resP = D.$p.apply({}, [textD, lbl].concat(o.errors.map(function (err) {
		    	if (err.e == "spell") {
		    		var elt = 		    		
		    			err.s.length > 0 ?
		    			 	D.$span(' ' + err.i[4], D.$span( D.$span.apply({}, err.s) ))
		    			 	: D.$span(' ' + err.i[4])
		    		return $(elt).attr('class','spell')[0];		    		        
		    	} else if (err.e == "gram") {
		    		var sentence = err.s.split(/\n/).shift().trim();
		    		var messageD = D.$pre(err.s.substr(sentence.length));//output.map(function (line) { return D.$pre(line); }));
		    		sentenceD = D.$span(sentence.substring(0,20) + '...');
		    		
		    		$(sentenceD).attr('class','gramSentence');
		    		$(messageD).attr('class','gramMessage');
		    		
		    		return $(D.$div(sentenceD, messageD)).attr('class','gram')[0];
		    	} else {
		    		throw 'unknown err: ' + err.e;
		    	}
		    })));
		  }
		
		return $(resP)
			.attr('id', 'paragraph_' + i)
			.attr('class','paragraph on')
			.click(function(){
			  var toggleOn = toggle(this);
			  //var toggleOn = $(this).attr('class').indexOf('off') == -1 ? true : false;
			  //toggleOn = !toggleOn;
			  //$(this).attr('class', 'paragraph' + (toggleOn ? '' : ' off'));
			  summarize();
		})[0];
	}




	
function bindDOM() {	
	var BASE_URL = document.URL.replace("#","").replace("viewjson.html","") + "/";
	var FILE =  'serviceHalf.json';
	
	var jsonP = Z.unit(BASE_URL + FILE).pipeAsync(D.xhrJSON).print('== jsonP');
	
	DOC = jsonP.pipe(function (v) { DOC = v; });
	
	
	var docP = jsonP.pipe(function (arr) {
	
		var paragraphs = arr.map(function (o, i) { return {m: o, v: formatParagraph(o, i)}; });

		//add file breaks
		var pages = paragraphs.reduce(function (acc, o) {
			if (acc.lastFile != o.m.file) {

				var files = o.m.file.split('/');
				if (files.length > 0) {
					var lastStr = files.pop();
					var last = $(D.$span(lastStr)).attr('class', 'fileName')[0];
					var dir = $(D.$span(files.join('/') + '/')).attr('class', 'dirName')[0];
					elt = D.$span(dir, last);
				} else {
					elt = D.$span(o.m.file);
				}			
			
				var lastFileD = $(D.$p(elt)).attr('class','file')[0];
				
				$(lastFileD).click(function () {
				    var toggleOn = toggle(this);
			  		//var toggleOn = $(this).attr('class').indexOf('off') == -1 ? true : false;
					//toggleOn = !toggleOn;
					//$(this).attr('class','file' + (toggleOn ? '' : ' off'));
					var rSib = this.nextSibling;
					while (rSib) {
						if ($(rSib).attr('class').indexOf('paragraph') != -1) {
							$(rSib).attr('class', 'paragraph' + (toggleOn ? '' : ' off'));
							rSib = rSib.nextSibling;
						} else {
							rSib = false;
						}
					}
					summarize();
				});
				
				
				acc.arr.push({m: {file: o.file}, v: lastFileD});
			}
			acc.arr.push(o);
			return {arr: acc.arr, lastFile: o.m.file};		
		}, {arr: [], lastFile: false});
		
		return D.$div.apply({}, pages.arr.map(function (o) { return o.v; }));
	}).print('== docP');



    $insertDB('#doc', docP);
    
    var toggleAllOn = true;
    $('#toggleAll').click(function () {
    	toggleAllOn = !toggleAllOn;
    	$('.paragraph').attr('class','paragraph' + (toggleAllOn ? ' on' : ' off'));
    	summarize();    
    });


	function getParagraph (i) {
		var res = null;
		$("p.paragraph").map(function (idx, d) { if (idx == i) res = this; });
		return res;
	}
	function mapOffSents (offs) {
		var res = {};
		offs.forEach(function (o) {
			if (!res[o.para]) res[o.para] = [];
			res[o.para].push(o.sent);
		});	
		return res;
	}
	
	function deTag (i) { 
		return i.replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
	}

	function makeTip (ratings) {
		var numOk = ratings.filter(function (o) { return o == 'ok'; }).length;

		var flagged = 
			ratings.map(function (o, i) { return [o, i + 1]; })
					.filter(function (arr) { return arr[0] != 'ok'; })
					.map(function (arr) { return arr[1]; })
					.join(', R');
					

		var words = {};

		Array.prototype.concat.apply([],
		ratings	
				.filter(function (i) { return i != 'ok' && i != 'ok:'; })							
				.map(function (i) { return i.split(/\n/); }))
		.forEach(function (line) {
			var keyM = line.match(/<[^>]*>/);
			if (!keyM) {
				//console.log('no keyM', line);
				return;
			}
			var key = keyM[0];
			if (!words.hasOwnProperty(key))
				words[key] = [];
			words[key].push(line.substring(key.length));
		});
		
		var bestWords = {};
		var remaining = {};
		for (var i in words) {
			var sorted = words[i].sort(
				function (a, b) { return b.length - a.length; });
			bestWords[i] = sorted[0];
			sorted.forEach(function (o, j) {
				if (j > 0) {
					if (!remaining[i]) remaining[i] = [];
					remaining[i].push(o);
				}
			});
		}

		var best = '';
		for (var i in bestWords) 
			best += deTag(i) + ' ' + bestWords[i] +'<br/>';
		var extra = '';
		for (var i in remaining)  {
			if (extra == '') extra = '<hr/>';
			for (var j = 0; j < remaining[i].length; j++)
				extra += deTag(i) + ' ' + remaining[i][j] + '<br/>'
		}
				
		return D.$div(
				D.$b( (ratings.length - numOk) + " Flagged (R" + flagged + ")"),
				D.$hr(),
				D.$span($('<span></span>').html(best + extra)[0]));
	}
	
	
	function fetchResults(jobID, flatSentences, batchID, paraSents) {
		$.get('api/improvements?jobID=' + jobID)
		 .done(function (data) {
//		 	try {
		 	    console.log('fetched', data);
		 		var out = JSON.parse(data);
		 		
		 		$('#resultCount').text(out.count + ' / ' + flatSentences.length + ' done');
		 		
		 		if (true || out.count == flatSentences.length) {
		 			if (out.count == flatSentences.length)
		 			  console.log('done, got all sentences', flatSentences, out.sentences);

					var flatDoms = Array.prototype.concat.apply([], 
    					paraSents.map(function () { return this.nodes; }));
		 			
		 			out.sentences.map(function (ratings, i) {

						//$(flatDoms[i]).replaceWith($(flatDoms[i]).clone()); //clear handlers

		 				if (!ratings) {
		 					//console.log('nothing for',i);
		 					return;
		 				}
						
		 				if (ratings.length == 0) {
		 					$(flatDoms[i]).fadeTo(1000, 1.0);
		 				} else {
							var numOk = ratings.filter(function (o) { return o == 'ok'; }).length;
							if (numOk != ratings.length) {
								var ratio = ratings.length == 0 ? 0 : (numOk / ratings.length);		 				
								var notes = 
									ratings
										.filter(function (i) { return i != 'ok' && i != 'ok:'; })
										.map(function (i) { return i.replace(/</g,'&lt;').replace(/>/g,'&gt;') })
										.join(' <hr/>');
								
								$(flatDoms[i])
									.css("background-color", 
										"rgb(255," 
											+ Math.round((ratio) * 200 + 55) + "," 
											+ Math.round((ratio) * 200 + 55) + ")")
									.addClass('badSentence');

								//tool tip
						 		var moveLeft = 20;
								var moveDown = 10;
								
								var tipText = makeTip(ratings);
																
								$(flatDoms[i])
									.hover(function(e) {
									  $('#tooltip')
										.html(tipText)
										.show()
										.attr('class','tip' + i)
										.css('position', 'absolute')
										.css('top', e.pageY + moveDown)
										.css('left', e.pageX + moveLeft)
										.css('background-color','yellow')
										.css('border', '1px solid black')								
										;
									}, function() {
										setTimeout(function() { 
											if ($('#tooltip').attr('class') == 'tip' + i)
												$('#tooltip').fadeOut(1000); 
										}, 3000);
									});
								$(flatDoms[i]).children().remove();
								$(flatDoms[i]).append($(tipText).clone().addClass('comment'));
																
							} else {
								$(flatDoms[i]).css('color','green');
//								console.log('all ok',$(flatDoms[i]).text());
							}
						}
		 			});
		 		}
		 		if (out.count != flatSentences.length) {
		 			console.log('Try again in ', out.repollDelayMS, 'ms, only got ', out.count, ' / ', flatSentences.length);
		 			setTimeout(function () {
		 					fetchResults(jobID, flatSentences, batchID, paraSents);
		 				}, out.repollDelayMS);
		 		} else {
		 			stopLaunchTimer();
		 		}

		 	rebuildScroll();

		 });		 
	}
	
	
    
    var batchID = 0;
    $('#query').click(function () {    
    	batchID++;
    	var summary = summarize(); //{paras: paras, onParas: on, offSents: offSents};
    	
    	var offSentMap = mapOffSents(summary.offSents);
    	
    	// {text: [ string ], nodes: [ dom] }
    	global2 = summary;
    	console.log('summary', summary);
    	var paraSents = summary.paras.map(function (id) {
    		if (summary.onParas.indexOf(id) == -1) return [];
    		
    		var paragraphD = getParagraph(id);
    		var offSents = offSentMap[id];
    		if (!offSents) offSents = [];    		
    		
    		var sents = [];
    		var sentsD = [];
    		$('.real span', paragraphD).map(function (i, d) {
    			if (offSents.indexOf(i) != -1) return null;
    			sents.push($(d).html());
    			sentsD.push(d);
			});
			return {text: sents, nodes: sentsD};
    	});
    	var flatSentences = Array.prototype.concat.apply([], 
    		paraSents.map(function () { 
    			var paraText = this.text;
    			return this.text.map(function (str, i) {
    				return str;
/*    				
    				var out = '';
    				if (i > 0) 
    				  out += paraText[i - 1] + '\n';
    				out += "<<<\n";
    				out += str + "\n";
    				out += ">>>";
    				if (i + 1 < paraText.length) 
    				  out += '\n' + paraText[i + 1];
    				return out;
*/    				
    			});
    		}));
    	
    	global = paraSents;
    	console.log(paraSents, paraSents.map(function (i) { return this.text; }));
    	console.log('sending', flatSentences);
    	
    	$.post('api/turkit', {sentences: flatSentences, batchID: batchID})
			.done(function (data) {
				try {
					console.log('got back', data);
					fetchResults(JSON.parse(data).jobID, flatSentences, batchID, paraSents);			
				} catch (exn) {
					console.log('failed to parse data', data, exn);
				}
			});
				

    });    
    
    $('#humani').click(function () {
		$.ajax({
			url: 'http://vivam.us/human/i',
			type: 'POST',
			success: function(result) {
				console.log('human/i result',result);
				global = result;
			}
		});    	    
    });
    $('#humano').click(function () {
		$.ajax({
			url: 'http://vivam.us/human/o',
			type: 'POST',
			success: function(result) {
				console.log('human/o result',result);
				global = result;
			}
		});    	    
    });
    

    
    $('#summarize').click(function () {
    	$('.badSentence').map(function () {
    		console.log('bad', $(this).text());
    	});
    }); 
    
    $('#query').click(function () {
		launchTimer();
	});

	docP.pipe(summarize).pipe(rebuildScroll);
}


$(function () {
	/*! jQuery visible 1.0.0 teamdf.com/jquery-plugins | teamdf.com/jquery-plugins/license */
	(function(d){d.fn.visible=function(e,i){var a=d(this).eq(0),f=a.get(0),c=d(window),g=c.scrollTop();c=g+c.height();var b=a.offset().top,h=b+a.height();a=e===true?h:b;b=e===true?b:h;return!!(i===true?f.offsetWidth*f.offsetHeight:true)&&b<=c&&a>=g}})(jQuery);
});
$(function () {
	
	var originalTopIdx = 0;
	var beforeScroll = $('#book').scrollTop();
	$('#book').scroll(function () { 	
		console.log('scroll');
		var paras = $('p.paragraph',this)

		//closest to top		
		var topMostIdx = -1;
		paras.each(function (i, e) {
			if ($(this).visible(true /* any part visible */)) {
				topMostIdx = i;
				return false;
			}
		});
		
		if (topMostIdx != originalTopIdx) {
			//scroll to it
			//$("#corrections").animate({
			//	scrollTop: $($("#corrections p")[topMostIdx]).offset().top});				
			$("#corrections p")[topMostIdx].scrollIntoView(true);
			originalTopIdx = topMostIdx;
			beforeScroll = $('#book').scrollTop();
		} else {
			$('#corrections').scrollTop(
				$('#corrections').scrollTop()
				+ $('#book').scrollTop() - beforeScroll);
			beforeScroll = $('#book').scrollTop();
		}
		
		//$("#corrections").scrollTop($(paras[topMostIdx]).scrollTop());
	});
});



function rebuildScroll () {


	$('#fixes').html('');
    var paragraphs = $('p.paragraph');
	var nodes = $.map(paragraphs, function (para) {
		var spellingMistakes = 
			D.$ol.apply({}, 
				$('.spell', para)
					.contents()
					.filter(function () { return this.nodeType == 3; })
					.map(function () { return D.$li($(this).text()); })
					.get());
		var corrections = 
			D.$p.apply({},
				$('.comment', para).clone());
    	return corrections;
    });
    nodes.forEach(function (elt) {
    	$('#fixes').append(elt);
    });
        
    /*
    $(window).bind('scroll', function() {    	
        paragraphs.each(function() {
            var post = $(this);
            
            var position = post.position().top - $(window).scrollTop();
            //positive: 
            
            if (position <= 0) {
                post.addClass('selected');
            } else {
                post.removeClass('selected');
            }
        });        
    });
    */

}

var startTime = false;
var theTimer = false;
function launchTimer () {
  startTime = new Date().getTime() - 150 * 1000;	
  theTimer = setInterval(function () {			
	  var t = (new Date().getTime()) - startTime;
	  if (t < 1000) t = t + 'ms';
	  else if (t < 60 * 1000) t = Math.round(t / 1000.0) + 's';
	  else if (t < 60 * 60 * 1000) {
	  	var min = Math.round(Math.floor(t / (60 * 1000.0)));
	  	var sec = Math.round((t - min * (60 * 1000))/1000.0);
	  	t = min + ':' + (sec < 10 ? '0' + sec : sec) + 'min';
	  } else t = (Math.round((t / (60 * 60 * 100.0))) / 10.0) + 'hr';  	  
	  $('#timeOutstanding').text('Time since launch: ' + t);
	}, 1 * 1000);
}
function stopLaunchTimer () {
	clearInterval(theTimer);
}    


window.addEventListener('load',bindDOM);
	
	</script>
  </head>
  <body>
  <div>
	  <div>
		<h2>Progress</h2>
		<span id="timeOutstanding">Time since launch</span>
		<br/>
		<span id="resultCount">No sentences done</span>      
	  </div>
	  <div id="summary"></div>
	  <div>
		<h2>Commands:</h2>
		<input id="toggleAll" type="button" value="toggle all"/>
		<input id="query" type="button" value="proofread!"/>
		<input id="humano" type="button" value="human/o (flush to turk)"/>
		<input id="humani" type="button" value="human/i (check turk)"/>
		<input id="summarize" type="button" value="summarize"/>
	  </div>
  </div>
  <div>
  	<div id="book">
  		<div id="doc"></div>
  	</div>
  	<div id="corrections">
  		<div id="fixes"></div>
  	</div>
  </div>
  <div id="tooltip"></div>
  </body>
</html>